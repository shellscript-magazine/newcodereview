#!/bin/bash -xv
#
# BUMON_DEMO.CGI : 部門マスタ参照画面 
#
# 作成日：2018/08/20
# 作成者：t.muramoto

####################################################################
# 環境変数の設定
####################################################################
export PATH=/home/UTL:/home/TOOL:/usr/local/bin/:${PATH}
export LANG=ja_JP.UTF-8
####################################################################

####################################################################
# 実行ログの出力
####################################################################
exec 2> /LOG/LOG.$(basename $0).$(date +%Y%m%d%H%M%S)

####################################################################
# 変数設定
####################################################################
# 日付
today=$(mdate today)

# ホームディレクトリ
homd=/home/usp/WEB/BUMON
# LV1ディレクトリ
lv1d=${homd}/LV1
# LV3ディレクトリ
lv3d=${homd}/LV3
# HTMLディレクトリ
htmd=${homd}/HTML
# SEMAPHOREディレクトリ
semd=${homd}/SEMAPHORE
# tmp
tmp=/tmp/$$

####################################################################
# エラーチェック関数
####################################################################
# ERROR_CHECK
ERROR_CHECK(){
        [ $(plus ${PIPESTATUS[@]}) -eq 0 ] && return
        # エラーの場合
        rm -rf $tmp-*
        touch $semd/$(basename $0).$HOSTNAME.ERROR.$today
        exit 1
}

####################################################################
#  画面表示用データ作成
####################################################################
# 表示データ取得
# 1:部門コード 2:部門名称                        3:担当者   4:適用開始日 5
# :適用終了日  6:適用フラグ（1:適用中 2:適用外） 7:登録日時
cat ${lv3d}/BUMON_MST  |
# 現在適用中のレコードを抽出
awk '$4<="'${today}'"' |
awk '$5>="'${today}'"' |
# 部門コード、適用開始日、登録日時でソート
msort key=1@4@7        |
# 部門コードをキーとして重複を削除
getlast 1 1            |
# 適用フラグで判断
delr 6 2               |
# 部門コードを5桁にする
maezero 1.5            > ${tmp}-bumon_data
ERROR_CHECK

# HTML加工
cat ${htmd}/BUMON_DEMO_MENU.HTML               |
# ###DATE###を変換
calsed "###DATE###" ${today} -                 |
# 文字をはめ込む
mojihame -l###BUMON_MST### - ${tmp}-bumon_data > ${tmp}-html
ERROR_CHECK

####################################################################
#  HTML表示
####################################################################
echo "Content-type:text/html"
echo ""
cat $tmp-html


####################################################################
# 終了処理
####################################################################
rm -f ${tmp}-*
exit 0
